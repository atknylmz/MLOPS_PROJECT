stages:
  - build
  - test
  - train
  - evaluate
  - deploy

variables:
  DOCKER_IMAGE: python:3.11

before_script:
  - pip install -r requirements.txt

# ============================================================================
# COMMIT STAGE - Basic syntax and import checks
# ============================================================================
build:syntax_check:
  stage: build
  script:
    - echo "ğŸ” Checking Python syntax..."
    - python -m py_compile src/**/*.py
    - echo "âœ“ All files have valid syntax"
  allow_failure: false

build:dependencies:
  stage: build
  script:
    - echo "ğŸ“¦ Installing dependencies..."
    - pip install -r requirements.txt
    - echo "âœ“ Dependencies installed successfully"
  allow_failure: false

# ============================================================================
# TEST STAGE - Unit and integration tests
# ============================================================================
test:unit_tests:
  stage: test
  script:
    - echo "ğŸ§ª Running unit tests..."
    - pytest tests/ -v --cov=src --cov-report=term-missing
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
  allow_failure: true

test:feature_engineering:
  stage: test
  script:
    - echo "ğŸ”§ Testing feature engineering..."
    - python -m pytest tests/test_hashed_transformer.py -v
    - python -m pytest tests/test_feature_cross.py -v
  allow_failure: false

# ============================================================================
# TRAINING STAGE - Incremental Learning Pipeline
# ============================================================================
train:incremental_models:
  stage: train
  script:
    - echo "ğŸš€ Starting Incremental Learning Pipeline..."
    - echo "ğŸ“Š Training 23 models with chunks of 1000 samples..."
    - python -m src.training.incremental_train
    - echo "âœ“ Incremental training completed"
  artifacts:
    paths:
      - artifacts/incremental_models/
      - artifacts/reports/
    expire_in: 30 days
  allow_failure: false
  timeout: 2 hours

# ============================================================================
# EVALUATION STAGE - Model comparison and selection
# ============================================================================
evaluate:compare_models:
  stage: evaluate
  dependencies:
    - train:incremental_models
  script:
    - echo "ğŸ“ˆ Evaluating all models..."
    - python src/registry/evaluate_incremental.py
    - echo "âœ“ Model evaluation completed"
  artifacts:
    paths:
      - artifacts/reports/
    expire_in: 30 days
  allow_failure: false

# ============================================================================
# DEPLOY STAGE - Push best model to production/GitHub
# ============================================================================
deploy:best_model:
  stage: deploy
  dependencies:
    - evaluate:compare_models
  script:
    - echo "ğŸ¯ Deploying best model..."
    - python src/registry/promote.py
    - echo "âœ“ Model promoted to production"
  only:
    - main
  allow_failure: false

deploy:github_push:
  stage: deploy
  dependencies:
    - deploy:best_model
  script:
    - echo "ğŸ“¤ Pushing results to GitHub..."
    - git config --global user.email "ci@mlops.local"
    - git config --global user.name "MLOps CI/CD"
    - git add artifacts/incremental_models artifacts/reports README.md
    - git commit -m "ci: incremental training results - best model pushed" || true
    - git push origin main || true
  only:
    - main
  allow_failure: false
